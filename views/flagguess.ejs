<%- include("partials/header.ejs") %>

<header class="game-header"> 
  <h2 class="welcome">Welcome, <%= username || (locals.username ?? "Player") %> üëã</h2>
  <div class="leaderboard-logout">
    <a href="/leaderboard" class="logout-btn">Leaderboard</a>
    <a href="/logout" class="logout-btn">Logout</a>
  </div>
</header>

<div id="app">
  <% if (wasCorrect === false) { %>
    <div class="end-screen">
      <h2>Game Over</h2>
      <p>Total Score: <strong><%= totalScore %></strong></p>
      <p class="correct-answer">The correct answer was <%= previousAnswer %>.</p>
      <div class="end-screen__actions">
        <a href="/flagguess" class="restart-button">Restart Game</a>
        <a href="/leaderboard" class="restart-button">View Leaderboard</a>
      </div>
    </div>
  <% } else { %>
    <form class="container" action="/submit" method="post">
      <div class="horizontal-container">
        <h3>
          Total Score: 
          <span id="score"><%= totalScore %></span>
        </h3>
      </div>

      <h1 
        id="countryFlag" 
        data-flag-emoji="<%= question.flag %>" 
        data-country-name="<%= question.name %>"
      >
        <%= question.flag %>
      </h1>

      <div class="answer-container">
        <input 
          type="text" 
          name="answer" 
          id="userInput" 
          placeholder="Name the country" 
          autofocus 
          autocomplete="off"
        >
      </div> 

      <button type="submit">SUBMIT</button>

      <% if (wasCorrect === true) { %>
        <p class="checkmark">‚úî Correct!</p>
      <% } %>
    </form>
  <% } %>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/twemoji.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  // Render the flag with twemoji when possible; gracefully fall back to raw emoji if it fails
  document.addEventListener("DOMContentLoaded", () => {
    const flagEl = document.getElementById("countryFlag");
    if (!flagEl) return;

    const emoji = (flagEl.dataset.flagEmoji || flagEl.textContent || "").trim();
    const countryName = (flagEl.dataset.countryName || "country").trim();

    const showInlineEmoji = () => {
      flagEl.textContent = emoji || "üè≥Ô∏è";
      flagEl.setAttribute("role", "img");
      flagEl.setAttribute("aria-label", `Flag of ${countryName}`);
    };

    if (!emoji) {
      showInlineEmoji();
      return;
    }

    if (!window.twemoji) {
      showInlineEmoji();
      return;
    }

    try {
      const parsed = twemoji.parse(emoji, { folder: "svg", ext: ".svg" });
      if (!parsed) {
        showInlineEmoji();
        return;
      }

      flagEl.innerHTML = parsed;
      const img = flagEl.querySelector("img.emoji");

      if (!img) {
        showInlineEmoji();
        return;
      }

      img.alt = `Flag of ${countryName}`;
      img.setAttribute("aria-label", img.alt);
      img.addEventListener("error", showInlineEmoji, { once: true });
    } catch (err) {
      showInlineEmoji();
    }
  });
</script>


<%- include("partials/footer.ejs") %>
